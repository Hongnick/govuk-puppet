#!/bin/bash

# Script to create compressed archives of the raw Graphite Whisper files.

TIMESTAMP=`date +%Y-%m-%d_%Hh%Mm.%A`

GRAPHITE_STORAGE_DIRECTORY="/opt/graphite/storage"
GRAPHITE_WHISPER_DIRECTORY_NAME="whisper"

GRAPHITE_WHISPER_DIRECTORY="${GRAPHITE_STORAGE_DIRECTORY}/${GRAPHITE_WHISPER_DIRECTORY_NAME}"

BACKUP_DIRECTORY_NAME="backups"

BACKUP_DIRECTORY=${GRAPHITE_STORAGE_DIRECTORY}/${BACKUP_DIRECTORY_NAME}

BACKUP_FILE_ROOT_NAME=${GRAPHITE_WHISPER_DIRECTORY_NAME}
BACKUP_FILE_NAME="${BACKUP_FILE_ROOT_NAME}-${TIMESTAMP}.tgz"

TAR_COMMAND="ionice -c 3 nice tar"

DAYS_TO_RETAIN="4"

# Create the backup directory if it's not there but only if the storage directory exists
if [ -d ${GRAPHITE_STORAGE_DIRECTORY} ]
then
  mkdir -p ${BACKUP_DIRECTORY}
else
  echo "Can't create backup directory"
  exit 1
fi

# Remove any backups older than 7 days
find ${BACKUP_DIRECTORY} -type f -mtime ${DAYS_TO_RETAIN} | xargs -xi rm {}

# Create compressed archive of the  Whisper files
${TAR_COMMAND} -acf ${BACKUP_DIRECTORY}/${BACKUP_FILE_NAME} ${GRAPHITE_WHISPER_DIRECTORY}
